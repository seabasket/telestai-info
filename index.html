<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>telestai.info</title>
<style>
  /*
    Colors:
      cream  #f5e6c8  -- text, borders
      brown  #230e02  -- page background
      black  #000000  -- terminal background
      green  #6ab95c  -- prompt
  */

  html {
    background: #230e02;
  }

  body {
    margin: 0;
    height: 100vh;
    background: #230e02;
    color: #f5e6c8;
    font-family: 'Lucida Console', monospace;
    font-size: clamp(0.45rem, 1vh, 0.85rem);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    letter-spacing: 0.3px;
    overflow: hidden;
    touch-action: none;
    position: fixed;
    width: 100vw;
  }
  pre { margin-top: 20px; color: #f5e6c8; font-size: 0.8rem; }
  .terminal-row {
    display: flex;
    align-items: center;
    gap: 8px;
    width: min(88vw, 420px);
  }
  @media (min-width: 700px) {
    .terminal-row { width: min(90vw, 800px); }
  }
  .terminal-window {
    display: flex;
    align-items: center;
    background: #000000;
    border: 1px solid #f5e6c8;
    border-radius: 6px;
    padding: 9px 14px;
    flex: 1;
    box-shadow: 0 0 24px rgba(0,0,0,0.6);
    min-width: 0;
  }
  .prompt {
    color: #6ab95c;
    white-space: nowrap;
    user-select: none;
    pointer-events: none;
    flex-shrink: 0;
    font-size: clamp(0.6rem, 2.2vw, 0.85rem);
  }
  .terminal-input {
    -webkit-appearance: none;
    appearance: none;
    color-scheme: dark;
    background: transparent;
    border: none;
    outline: none;
    color: #f5e6c8 !important;
    -webkit-text-fill-color: #f5e6c8 !important;
    -webkit-box-shadow: 0 0 0 1000px #000000 inset !important;
    box-shadow: 0 0 0 1000px #000000 inset !important;
    font-family: 'Lucida Console', monospace;
    font-size: clamp(0.6rem, 2.2vw, 0.85rem);
    flex: 1;
    caret-color: #f5e6c8;
    min-width: 0;
    padding: 0;
    margin: 0;
    opacity: 1;
    border-radius: 0;
  }
  .terminal-input:focus {
    -webkit-box-shadow: 0 0 0 1000px #000000 inset !important;
    box-shadow: 0 0 0 1000px #000000 inset !important;
    -webkit-text-fill-color: #f5e6c8 !important;
  }
  .submit-btn {
    -webkit-appearance: none;
    appearance: none;
    color-scheme: dark;
    font-family: 'Lucida Console', monospace;
    font-size: clamp(0.6rem, 2.2vw, 0.85rem);
    background-color: #000000 !important;
    color: #f5e6c8 !important;
    -webkit-text-fill-color: #f5e6c8 !important;
    border: 1px solid #f5e6c8;
    border-radius: 6px;
    padding: 7px 10px;
    cursor: pointer;
    letter-spacing: 0.3px;
    white-space: nowrap;
    flex-shrink: 0;
  }
  .submit-btn:hover, .submit-btn:active {
    opacity: 0.7;
  }
  .box {
    text-align: center;
  }
  .fade-out {
    opacity: 0;
    transition: opacity 0.3s ease-out;
  }
</style>
</head>
<body>

<div class="box">

<div class="terminal-row">
  <form class="terminal-window" onsubmit="check(); return false;">
    <span class="prompt" id="prompt">visitor@... ~ %&nbsp;</span>
    <input type="text" class="terminal-input" id="code" maxlength="11" autofocus autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
  </form>
  <button class="submit-btn" onclick="check()">enter</button>
</div>

<div id="msg"></div>
<div id="history"></div>
</div>

<div id="access-granted" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-family:'Lucida Console',monospace; color:#f5e6c8; font-size:clamp(0.7rem,2.5vw,1rem); white-space:nowrap; letter-spacing:0.3px; transition:opacity 0.4s ease-out;">&gt; <span style="color:#6ab95c;">ACCESS GRANTED</span> --&gt; redirecting...</div>

<script>
const CODE_PATTERN = /^[a-z]{2}-[a-z0-9]{3,8}$/;

function getDeviceName() {
  const ua = navigator.userAgent.toLowerCase();
  if (/iphone/.test(ua)) return 'iphone';
  if (/ipad/.test(ua)) return 'ipad';
  if (/android/.test(ua)) return 'android';
  if (/macintosh|mac os x/.test(ua)) return 'mac';
  if (/windows/.test(ua)) return 'windows';
  if (/linux/.test(ua)) return 'linux';
  return null;
}

function getBrowserName() {
  const ua = navigator.userAgent.toLowerCase();
  if (/edg\//.test(ua)) return 'edge';
  if (/opr\/|opera/.test(ua)) return 'opera';
  if (/firefox/.test(ua)) return 'firefox';
  if (/chrome/.test(ua)) return 'chrome';
  if (/safari/.test(ua)) return 'safari';
  return null;
}

async function getPublicIP() {
  try {
    const res = await fetch('https://api.ipify.org?format=json');
    const data = await res.json();
    return data.ip;
  } catch {
    return 'unknown';
  }
}

(async () => {
  const device = getDeviceName();
  const browser = getBrowserName();
  const label = device && browser ? `${device}-${browser}`
              : device || browser || 'visitor';
  const ip = await getPublicIP();
  document.getElementById('prompt').textContent = `${label}@${ip} ~ % \u00a0`;
})();

// SHA-256 hashes of known page codes. To add a new page:
//   echo -n "your-code" | shasum -a 256
const KNOWN_HASHES = new Set([
  "42e47f2fe6b7d410f0a5991928f14ca370d22656ce1a6990dbb23f3f86001e98", // ts-0001
  "7e9d4370f98d07993360bd4758d90695bb55643f814b714c1075cdec92d6bf10", // ts-snri314
  "a4262e1c9bcbc1721eb3fe13558154460a2b2a2d307daa32532478526ce6ccb1"  // about
]);

async function hashInput(str) {
  const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
}

function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? JSON.parse(decodeURIComponent(match[2])) : [];
}

function setCookie(name, value, days = 365) {
  const d = new Date();
  d.setTime(d.getTime() + (days*24*60*60*1000));
  document.cookie = name + "=" + encodeURIComponent(JSON.stringify(value)) + ";expires=" + d.toUTCString() + ";path=/";
}

let correctHistory = getCookie("correctHistory") || [];

if (correctHistory.length) {
  document.getElementById("history").innerHTML = "<pre>used access codes:\n" + correctHistory.join("\n") + "</pre>";
}

// Auto-lowercase on input
const codeInput = document.getElementById("code");
codeInput.addEventListener('input', () => {
  const pos = codeInput.selectionStart;
  codeInput.value = codeInput.value.toLowerCase();
  codeInput.setSelectionRange(pos, pos);
});


async function check() {
  const input = document.getElementById("code").value.toLowerCase().trim();
  const msg = document.getElementById("msg");
  const hash = await hashInput(input);

  if (!KNOWN_HASHES.has(hash)) {
    if (CODE_PATTERN.test(input)) {
      msg.innerHTML = "<pre style='color:#ff5555'>theres no page for that code :((</pre>";
    } else {
      msg.innerHTML = "<pre style='color:#ff5555'>theres no page for that code :((\ncodes usually look like \"xx-something\"</pre>";
    }
    return;
  }

  if (!correctHistory.includes(input)) {
    correctHistory.push(input);
    setCookie("correctHistory", correctHistory);
  }

  // Fade out the input UI
  document.querySelector('.box').classList.add('fade-out');

  // Show access granted message
  const granted = document.getElementById('access-granted');
  setTimeout(() => {
    granted.style.display = 'block';
  }, 320);

  // Fade message and background to black
  setTimeout(() => {
    document.body.style.transition = 'background-color 0.4s ease-out';
    document.body.style.backgroundColor = '#000000';
    granted.style.opacity = '0';
  }, 1300);

  // Redirect
  setTimeout(() => {
    location.href = input + ".html";
  }, 2000);
}
</script>
</body>
</html>
